<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Indian Library Project</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>

  <style>
    :root { 
      --primary: #2c3e50; 
      --accent: #e67e22; 
      --bg: #f4f7f6; 
      --sidebar-width: 320px;
    }
    
    body { margin:0; display:flex; font-family: 'Segoe UI', sans-serif; height: 100vh; background: var(--bg); overflow: hidden; }
    
    #sidebar { 
      width: var(--sidebar-width); padding:20px; background:white; 
      overflow-y:auto; border-right: 1px solid #ddd; z-index: 2000;
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
      transition: transform 0.3s ease;
    }
    
    #map { flex:1; height: 100vh; z-index: 1; }

    #menuToggle {
      display: none; position: absolute; top: 15px; left: 15px;
      z-index: 2100; background: var(--primary); color: white;
      border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;
    }

    .control-group { margin-bottom: 15px; }
    label { font-size: 0.8rem; font-weight: bold; color: #666; text-transform: uppercase; }
    input, select, button { 
      width: 100%; padding: 12px; margin-top: 5px; 
      border-radius: 6px; border: 1px solid #dfe6e9; box-sizing: border-box; font-size: 16px; 
    }
    button { background: var(--primary); color: white; border: none; font-weight: 600; cursor: pointer; }
    
    #network {
      position:absolute; top:70px; right:20px; width:280px; height:280px;
      background:rgba(255,255,255,0.95); border-radius: 12px; 
      box-shadow: 0 10px 25px rgba(0,0,0,0.1); display:none; z-index:1000;
    }
    
    .stats-panel { background: #f8f9fa; padding: 12px; border-radius: 8px; margin-top: 10px; border: 1px solid #eee; }
    canvas { max-width: 100%; margin-top: 15px; }

    /* FIXED TIMELINE POSITIONING */
    .slider-container {
      position:absolute; bottom:25px; 
      left: calc(var(--sidebar-width) + 25px); 
      right: 25px;
      background: white; padding: 10px 25px; border-radius: 50px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1500;
      display: flex; align-items: center; gap: 15px;
      transition: left 0.3s ease;
    }
    #yearRange { flex-grow: 1; accent-color: var(--accent); cursor: pointer; }
    #playBtn { width: auto; padding: 8px 15px; }
    .popup-img { width: 100%; height: 120px; object-fit: cover; border-radius: 4px; margin-top: 8px; }

    /* MOBILE RESPONSIVENESS */
    @media (max-width: 768px) {
      #sidebar {
        position: absolute; left: 0; top: 0; bottom: 0;
        transform: translateX(-100%);
      }
      #sidebar.active { transform: translateX(0); }
      #menuToggle { display: block; }
      .slider-container { 
        left: 15px; right: 15px; bottom: 15px;
        padding: 10px 15px;
      }
      .slider-container strong { display: none; }
    }
  </style>
</head>
<body>

<button id="menuToggle" onclick="toggleSidebar()">‚ò∞ Menu</button>

<div id="sidebar">
  <h2 style="margin-top:0; color: var(--primary); display: flex; justify-content: space-between; align-items: center;">
    Indian Library Project<span onclick="toggleSidebar()" style="color: #ccc; font-size: 24px; cursor: pointer; display: none;" class="close-icon">‚úï</span>
  </h2>
  
  <div class="control-group">
    <label>Search Libraries</label>
    <input id="searchBox" placeholder="Library name...">
  </div>

  <div class="control-group">
    <label>Institution Type</label>
    <select id="categoryFilter">
      <option value="all">All Institutions</option>
      <option value="University">University</option>
      <option value="Public">Public</option>
      <option value="Private">Private</option>
    </select>
  </div>

  <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
    <button onclick="toggleHeatmap()" style="background:#d63031">üî• Heatmap</button>
    <button onclick="toggleNetwork()" style="background:#0984e3">üîó Network</button>
  </div>
  
  <button style="margin-top:10px; background:#27ae60;" onclick="locateUser()">üìç Near Me</button>
  <button style="margin-top:10px; background:#636e72;" onclick="resetView()">üáÆüá≥ Reset Map</button>

  <div class="stats-panel">
    <strong>Total Records:</strong> <span id="count" style="color:var(--accent); font-size:1.2rem;">0</span>
  </div>

  <canvas id="yearChart"></canvas>
  <canvas id="stateChart"></canvas>
</div>

<div id="map"></div>
<div id="network"></div>

<div class="slider-container">
  <strong style="white-space:nowrap;">Year: <span id="yearValue" style="color:var(--accent)">2025</span></strong>
  <input type="range" id="yearRange" min="1500" max="2025" value="2025">
  <button id="playBtn" onclick="toggleTimeline()">‚ñ∂ Play</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
// --- GLOBALS ---
let data = [], filteredData = [];
let map, clusters, heatLayer, geoLayer, districtLayer;
let yearChart, stateChart, timer = null;
let networkOn = false, heatOn = false;

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('active');
}

// --- INITIALIZATION ---
function initMap() {
  map = L.map('map', { 
    doubleClickZoom: false, 
    zoomSnap: 0.1,
    zoomControl: false 
  }).setView([22.5, 80], 4.5);
  
  L.control.zoom({ position: 'topright' }).addTo(map);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
  
  clusters = L.markerClusterGroup({ spiderfyOnMaxZoom: true, showCoverageOnHover: false });
  map.addLayer(clusters);
}

// --- DATA LOGIC ---
fetch('libraries_full.json').then(r => r.json()).then(d => {
  data = d;
  updateDisplay();
  drawCharts();
  loadIndiaGeo();
});

function updateDisplay() {
  const year = parseInt(document.getElementById('yearRange').value);
  const cat = document.getElementById('categoryFilter').value;
  const search = document.getElementById('searchBox').value.toLowerCase();
  
  filteredData = data.filter(d => 
    d.year <= year && 
    (cat === 'all' || d.category === cat) && 
    (d.name.toLowerCase().includes(search))
  );
  
  renderMarkers(filteredData);
  document.getElementById('count').innerText = filteredData.length;
}

function renderMarkers(arr) {
  clusters.clearLayers();
  arr.forEach(lib => {
    const imgHtml = lib.image ? `<img src="${lib.image}" class="popup-img">` : '';
    clusters.addLayer(L.marker([lib.lat, lib.lon]).bindPopup(
      `${imgHtml}<br><strong>${lib.name}</strong><br>District: ${lib.district}<br>Year: ${lib.year}`
    ));
  });
}

function getCount(name, level) {
  return data.filter(d => d[level]?.toLowerCase().trim() === name.toLowerCase().trim()).length;
}

// --- GEOSPATIAL LOGIC (FIXED HIGHLIGHTS) ---
function loadIndiaGeo() {
  if (geoLayer) map.removeLayer(geoLayer);
  fetch('india_states.geojson').then(r => r.json()).then(json => {
    geoLayer = L.geoJSON(json, {
      style: { color: '#2c3e50', weight: 1.5, fillOpacity: 0.1, fillColor: '#2c3e50' },
      onEachFeature: function(f, l) {
        const stateName = f.properties.ST_NM || f.properties.NAME_1 || f.properties.name;
        l.bindTooltip(`<b>${stateName}</b>: ${getCount(stateName, 'state')}`, { sticky: true });
        
        l.on('mouseover', function() { 
          // Forced Reset for India layer
          geoLayer.eachLayer(lyr => geoLayer.resetStyle(lyr)); 
          this.setStyle({ fillOpacity: 0.3, color: '#e67e22', weight: 3 }); 
          this.bringToFront();
        });
        
        l.on('mouseout', function() { geoLayer.resetStyle(this); });
        
        l.on('click', function() { 
          geoLayer.eachLayer(lyr => geoLayer.resetStyle(lyr));
          map.fitBounds(this.getBounds()); 
          loadDistricts(stateName);
          if(window.innerWidth < 768) toggleSidebar(); 
        });
      }
    }).addTo(map);
  });
}

function loadDistricts(stateName) {
  if (districtLayer) map.removeLayer(districtLayer);
  geoLayer.setStyle({ fillOpacity: 0.05, weight: 1, color: '#bdc3c7' });
  
  const fileName = stateName.replace(/\s/g, '') + ".geojson";
  fetch(fileName).then(r => r.json()).then(json => {
    districtLayer = L.geoJSON(json, {
      style: { color: '#e67e22', weight: 1.2, fillOpacity: 0.1, fillColor: '#f39c12' },
      onEachFeature: function(f, l) {
        const distName = f.properties.NAME_2 || f.properties.district || f.properties.name;
        l.bindTooltip(`<b>${distName}</b>: ${getCount(distName, 'district')}`, { sticky: true });
        
        l.on('mouseover', function() { 
          // Forced Reset for District layer
          districtLayer.eachLayer(lyr => districtLayer.resetStyle(lyr));
          this.setStyle({ fillOpacity: 0.4, weight: 2.5, color: '#d35400' }); 
          this.bringToFront();
        });
        
        l.on('mouseout', function() { districtLayer.resetStyle(this); });
        
        l.on('click', function(e) { 
          L.DomEvent.stopPropagation(e); 
          filterByLoc(distName, 'district'); 
        });
      }
    }).addTo(map);
  });
  filterByLoc(stateName, 'state');
}

function filterByLoc(name, level) {
  const locData = data.filter(d => d[level]?.toLowerCase().trim() === name.toLowerCase().trim());
  renderMarkers(locData);
  document.getElementById('count').innerText = locData.length;
}

function resetView() {
  if (districtLayer) map.removeLayer(districtLayer);
  if (geoLayer) geoLayer.eachLayer(lyr => geoLayer.resetStyle(lyr));
  map.setView([22.5, 80], 4.5);
  updateDisplay();
}

function locateUser() {
  map.locate({setView: true, maxZoom: 12});
  map.on('locationfound', function(e) {
    L.circle(e.latlng, e.accuracy).addTo(map).bindPopup("You are here").openPopup();
  });
}

// --- VISUALIZATIONS ---
function drawCharts() {
  const years = {};
  data.forEach(d => years[d.year] = (years[d.year] || 0) + 1);
  const sortedYears = Object.keys(years).sort((a,b) => a-b);
  if(yearChart) yearChart.destroy();
  yearChart = new Chart(document.getElementById('yearChart'), {
    type: 'line',
    data: { labels: sortedYears, datasets: [{ label: 'Growth', data: sortedYears.map(y => years[y]), borderColor: '#e67e22', tension: 0.3 }] },
    options: { plugins: { legend: { display: false } } }
  });

  const states = {};
  data.forEach(d => states[d.state] = (states[d.state] || 0) + 1);
  const topStates = Object.entries(states).sort((a,b) => b[1]-a[1]).slice(0,5);
  if(stateChart) stateChart.destroy();
  stateChart = new Chart(document.getElementById('stateChart'), {
    type: 'bar',
    data: { labels: topStates.map(s => s[0]), datasets: [{ label: 'Count', data: topStates.map(s => s[1]), backgroundColor: '#2c3e50' }] },
    options: { plugins: { legend: { display: false } } }
  });
}

const yrRange = document.getElementById('yearRange');
yrRange.oninput = () => { document.getElementById('yearValue').innerText = yrRange.value; updateDisplay(); };

function toggleTimeline() {
  const btn = document.getElementById('playBtn');
  if (timer) { clearInterval(timer); timer = null; btn.innerText = "‚ñ∂ Play"; }
  else {
    btn.innerText = "‚è∏ Pause";
    timer = setInterval(() => {
      if (yrRange.value >= 2025) { clearInterval(timer); timer = null; btn.innerText = "‚ñ∂ Play"; return; }
      yrRange.value = parseInt(yrRange.value) + 1; yrRange.oninput();
    }, 150);
  }
}

function toggleHeatmap() {
  heatOn = !heatOn;
  if (heatLayer) map.removeLayer(heatLayer);
  if (heatOn) heatLayer = L.heatLayer(filteredData.map(d => [d.lat, d.lon, 0.5]), { radius: 20, blur: 15 }).addTo(map);
}

function toggleNetwork() {
  networkOn = !networkOn;
  document.getElementById("network").style.display = networkOn ? "block" : "none";
  if (networkOn) drawNetwork();
}

function drawNetwork() {
  d3.select("#network").html("");
  const w = 280, h = 280;
  const svg = d3.select("#network").append("svg").attr("width", w).attr("height", h);
  const nodes = data.map(d => ({ id: d.id, name: d.name }));
  const links = [];
  data.forEach(d => { if (d.connections) d.connections.forEach(t => links.push({ source: d.id, target: t })); });
  const sim = d3.forceSimulation(nodes).force("link", d3.forceLink(links).id(d => d.id).distance(40)).force("charge", d3.forceManyBody().strength(-80)).force("center", d3.forceCenter(w/2, h/2));
  const link = svg.selectAll("line").data(links).enter().append("line").attr("stroke", "#ccc");
  const node = svg.selectAll("circle").data(nodes).enter().append("circle").attr("r", 5).attr("fill", "#e67e22");
  sim.on("tick", () => {
    link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
    node.attr("cx", d => d.x).attr("cy", d => d.y);
  });
}

initMap();
document.getElementById('searchBox').addEventListener('input', updateDisplay);
document.getElementById('categoryFilter').addEventListener('change', updateDisplay);
</script>
</body>
</html>
