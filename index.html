<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Digital Library Atlas Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>

  <style>
    :root { --primary: #2c3e50; --accent: #e67e22; --bg: #f4f7f6; }
    body { margin:0; display:flex; font-family: 'Segoe UI', sans-serif; height: 100vh; background: var(--bg); overflow: hidden; }
    
    #sidebar { 
      width:320px; padding:20px; background:white; 
      overflow-y:auto; border-right: 1px solid #ddd; z-index: 1001;
      box-shadow: 2px 0 10px rgba(0,0,0,0.05);
    }
    #map { flex:1; background: #aad3df; }

    .control-group { margin-bottom: 20px; }
    label { font-size: 0.85rem; font-weight: bold; color: #666; text-transform: uppercase; }
    input, select, button { 
      width: 100%; padding: 10px; margin-top: 5px; 
      border-radius: 6px; border: 1px solid #dfe6e9; box-sizing: border-box;
    }
    button { 
      background: var(--primary); color: white; cursor: pointer; border: none;
      font-weight: 600; transition: all 0.2s;
    }
    button:hover { background: #34495e; transform: translateY(-1px); }
    
    #network {
      position:absolute; top:20px; right:20px; width:320px; height:320px;
      background:rgba(255,255,255,0.95); border-radius: 12px; 
      box-shadow: 0 10px 25px rgba(0,0,0,0.1); display:none; z-index:1000;
      border: 1px solid #eee;
    }
    
    .stats-panel { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #eee; }
    canvas { max-width: 100%; margin-top: 20px; }

    .slider-container {
      position:absolute; bottom:30px; left:350px; right: 30px;
      background: white; padding: 15px 25px; border-radius: 50px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 999;
      display: flex; align-items: center; gap: 20px;
    }
    #yearRange { flex-grow: 1; accent-color: var(--accent); }
    
    .popup-img { width: 100%; height: 120px; object-fit: cover; border-radius: 4px; margin-top: 8px; }
    .leaflet-tooltip { font-weight: bold; border-radius: 4px; border: none !important; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
  </style>
</head>
<body>

<div id="sidebar">
  <h2 style="margin-top:0; color: var(--primary);">ðŸ“š Library Atlas</h2>
  
  <div class="control-group">
    <label>Search Libraries</label>
    <input id="searchBox" placeholder="Search by name...">
  </div>

  <div class="control-group">
    <label>Filter by Type</label>
    <select id="categoryFilter">
      <option value="all">All Institutions</option>
      <option value="University">University</option>
      <option value="Public">Public</option>
      <option value="Private">Private</option>
    </select>
  </div>

  <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
    <button onclick="toggleHeatmap()" style="background:#d63031">ðŸ”¥ Heatmap</button>
    <button onclick="toggleNetwork()" style="background:#0984e3">ðŸ”— Network</button>
  </div>
  
  <button style="margin-top:10px; background:#636e72;" onclick="resetView()">ðŸ‡®ðŸ‡³ Reset Map</button>

  <div class="stats-panel">
    <strong>Total Found:</strong> <span id="count" style="color:var(--accent); font-size:1.2rem;">0</span>
  </div>

  <canvas id="yearChart"></canvas>
  <canvas id="stateChart"></canvas>
</div>

<div id="map"></div>
<div id="network"></div>

<div class="slider-container">
  <strong style="white-space:nowrap;">Year: <span id="yearValue" style="color:var(--accent)">2025</span></strong>
  <input type="range" id="yearRange" min="1500" max="2025" value="2025">
  <button id="playBtn" style="width: 80px;" onclick="toggleTimeline()">â–¶ Play</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
// --- GLOBALS ---
let data = [], filteredData = [];
let map, clusters, heatLayer, geoLayer, districtLayer;
let yearChart, stateChart;
let timer = null;
let networkOn = false, heatOn = false;

// --- INITIALIZATION ---
function initMap() {
  map = L.map('map', { doubleClickZoom: false, zoomSnap: 0.1 }).setView([22.5, 80], 4.5);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
  clusters = L.markerClusterGroup({ spiderfyOnMaxZoom: true, showCoverageOnHover: false });
  map.addLayer(clusters);
}

// --- DATA LOADING ---
fetch('libraries_full.json').then(r => r.json()).then(d => {
  data = d;
  updateDisplay();
  drawCharts();
  loadIndiaGeo();
});

function updateDisplay() {
  const year = parseInt(document.getElementById('yearRange').value);
  const cat = document.getElementById('categoryFilter').value;
  const search = document.getElementById('searchBox').value.toLowerCase();

  filteredData = data.filter(d => 
    d.year <= year && 
    (cat === 'all' || d.category === cat) &&
    (d.name.toLowerCase().includes(search))
  );

  renderMarkers(filteredData);
  document.getElementById('count').innerText = filteredData.length;
}

function renderMarkers(arr) {
  clusters.clearLayers();
  arr.forEach(lib => {
    const imgHtml = lib.image ? `<img src="${lib.image}" class="popup-img">` : '';
    const marker = L.marker([lib.lat, lib.lon])
      .bindPopup(`${imgHtml}<br><strong>${lib.name}</strong><br>District: ${lib.district}<br>Est: ${lib.year}`);
    clusters.addLayer(marker);
  });
}

function getCount(name, level) {
  return data.filter(d => d[level]?.toLowerCase().trim() === name.toLowerCase().trim()).length;
}

// --- DRILL-DOWN LOGIC WITH GUARANTEED CLEAR ---
function loadIndiaGeo() {
  if (geoLayer) map.removeLayer(geoLayer);
  if (districtLayer) map.removeLayer(districtLayer);

  fetch('india_states.geojson').then(r => r.json()).then(json => {
    geoLayer = L.geoJSON(json, {
      style: { color: '#2c3e50', weight: 1.5, fillOpacity: 0.1, fillColor: '#2c3e50' },
      onEachFeature: function(f, l) {
        const stateName = f.properties.ST_NM || f.properties.NAME_1 || f.properties.name;
        const count = getCount(stateName, 'state');
        l.bindTooltip(`<b>${stateName}</b><br>Libraries: ${count}`, { sticky: true });

        l.on('mouseover', function(e) {
          // FORCED RESET: Clear all other states before highlighting this one
          geoLayer.eachLayer(layer => geoLayer.resetStyle(layer));
          
          this.setStyle({ fillOpacity: 0.3, color: '#e67e22', weight: 3 });
          this.bringToFront();
        });

        l.on('mouseout', function(e) {
          geoLayer.resetStyle(this);
        });

        l.on('click', function(e) {
          geoLayer.eachLayer(layer => geoLayer.resetStyle(layer)); // Clear highlights
          map.fitBounds(this.getBounds());
          loadDistricts(stateName);
        });
      }
    }).addTo(map);
  });
}

function loadDistricts(stateName) {
  if (districtLayer) map.removeLayer(districtLayer);
  
  // Freeze state layer as a static background
  geoLayer.setStyle({ fillOpacity: 0.05, weight: 1, color: '#bdc3c7' });

  const fileName = stateName.replace(/\s/g, '') + ".geojson";
  fetch(fileName).then(r => r.json()).then(json => {
    districtLayer = L.geoJSON(json, {
      style: { color: '#e67e22', weight: 1.2, fillOpacity: 0.1, fillColor: '#f39c12' },
      onEachFeature: function(f, l) {
        const distName = f.properties.NAME_2 || f.properties.district || f.properties.name;
        const dCount = getCount(distName, 'district');
        l.bindTooltip(`<b>${distName}</b><br>Libraries: ${dCount}`, { sticky: true });

        l.on('mouseover', function(e) {
          // FORCED RESET: Clear all other districts before highlighting this one
          districtLayer.eachLayer(layer => districtLayer.resetStyle(layer));
          
          this.setStyle({ fillOpacity: 0.4, weight: 2.5, color: '#d35400' });
          this.bringToFront();
        });

        l.on('mouseout', function(e) {
          districtLayer.resetStyle(this);
        });

        l.on('click', function(e) {
          L.DomEvent.stopPropagation(e);
          filterByLoc(distName, 'district');
        });
      }
    }).addTo(map);
  }).catch(() => console.warn("GeoJSON not found for: " + stateName));
  
  filterByLoc(stateName, 'state');
}

function filterByLoc(name, level) {
  const locData = data.filter(d => d[level]?.toLowerCase().trim() === name.toLowerCase().trim());
  renderMarkers(locData);
  document.getElementById('count').innerText = locData.length;
}

function resetView() {
  if (districtLayer) map.removeLayer(districtLayer);
  if (geoLayer) {
    geoLayer.eachLayer(layer => geoLayer.resetStyle(layer));
    geoLayer.setStyle({ color: '#2c3e50', weight: 1.5, fillOpacity: 0.1, fillColor: '#2c3e50' });
  }
  map.setView([22.5, 80], 4.5);
  updateDisplay();
}

// --- VISUALIZATIONS ---
function drawCharts() {
  const years = {};
  data.forEach(d => years[d.year] = (years[d.year] || 0) + 1);
  const sortedYears = Object.keys(years).sort((a,b) => a-b);
  if(yearChart) yearChart.destroy();
  yearChart = new Chart(document.getElementById('yearChart'), {
    type: 'line',
    data: { labels: sortedYears, datasets: [{ label: 'Growth', data: sortedYears.map(y => years[y]), borderColor: '#e67e22', tension: 0.3 }] },
    options: { plugins: { legend: { display: false } } }
  });

  const states = {};
  data.forEach(d => states[d.state] = (states[d.state] || 0) + 1);
  const topStates = Object.entries(states).sort((a,b) => b[1]-a[1]).slice(0,5);
  if(stateChart) stateChart.destroy();
  stateChart = new Chart(document.getElementById('stateChart'), {
    type: 'bar',
    data: { labels: topStates.map(s => s[0]), datasets: [{ label: 'Count', data: topStates.map(s => s[1]), backgroundColor: '#2c3e50' }] },
    options: { plugins: { legend: { display: false } } }
  });
}

const yrRange = document.getElementById('yearRange');
yrRange.oninput = () => {
  document.getElementById('yearValue').innerText = yrRange.value;
  updateDisplay();
};

function toggleTimeline() {
  const btn = document.getElementById('playBtn');
  if (timer) {
    clearInterval(timer); timer = null; btn.innerText = "â–¶ Play";
  } else {
    btn.innerText = "â¸ Pause";
    timer = setInterval(() => {
      if (yrRange.value >= 2025) { clearInterval(timer); timer = null; btn.innerText = "â–¶ Play"; return; }
      yrRange.value = parseInt(yrRange.value) + 1; yrRange.oninput();
    }, 150);
  }
}

function toggleHeatmap() {
  heatOn = !heatOn;
  if (heatLayer) map.removeLayer(heatLayer);
  if (heatOn) heatLayer = L.heatLayer(filteredData.map(d => [d.lat, d.lon, 0.5]), { radius: 20, blur: 15 }).addTo(map);
}

function toggleNetwork() {
  networkOn = !networkOn;
  document.getElementById("network").style.display = networkOn ? "block" : "none";
  if (networkOn) drawNetwork();
}

function drawNetwork() {
  d3.select("#network").html("");
  const w = 320, h = 320;
  const svg = d3.select("#network").append("svg").attr("width", w).attr("height", h);
  const nodes = data.map(d => ({ id: d.id, name: d.name }));
  const links = [];
  data.forEach(d => { if (d.connections) d.connections.forEach(t => links.push({ source: d.id, target: t })); });
  const sim = d3.forceSimulation(nodes).force("link", d3.forceLink(links).id(d => d.id).distance(40)).force("charge", d3.forceManyBody().strength(-80)).force("center", d3.forceCenter(w/2, h/2));
  const link = svg.selectAll("line").data(links).enter().append("line").attr("stroke", "#ccc");
  const node = svg.selectAll("circle").data(nodes).enter().append("circle").attr("r", 5).attr("fill", "#e67e22");
  sim.on("tick", () => {
    link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
    node.attr("cx", d => d.x).attr("cy", d => d.y);
  });
}

initMap();
document.getElementById('searchBox').addEventListener('input', updateDisplay);
document.getElementById('categoryFilter').addEventListener('change', updateDisplay);
</script>
</body>
</html>
